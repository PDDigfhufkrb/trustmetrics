// –í—Ö–æ–¥ - –†–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê
async function login() {
    const code = document.getElementById('code').value;
    const agree = document.getElementById('agree').checked;
    const message = document.getElementById('message');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è
    if (!agree) {
        showMessage('‚ùå –î–ª—è –≤—Ö–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Telegram
    if (!telegramClicked) {
        showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞
    if (!code.match(/^\d{3}-\d{3}$/)) {
        showMessage('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç XXX-XXX', 'error');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    showMessage('üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥...', 'success');
    document.getElementById('loginBtn').disabled = true;
    document.getElementById('loginBtn').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
    
    try {
        // –†–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ß–ï–†–ï–ó API
        const response = await fetch('verify-code.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–±–∏–Ω–µ—Ç...', 'success');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (result.token) {
                localStorage.setItem('auth_token', result.token);
                localStorage.setItem('user_id', result.user_id);
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏
            localStorage.removeItem('telegramClicked');
            telegramClicked = false;
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–±–∏–Ω–µ—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = 'cabinet.html';
            }, 2000);
            
        } else {
            showMessage(`‚ùå ${result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –≤ Telegram'}`, 'error');
            document.getElementById('loginBtn').textContent = '–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç';
            document.getElementById('loginBtn').disabled = false;
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ', 'error');
        document.getElementById('loginBtn').textContent = '–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç';
        document.getElementById('loginBtn').disabled = false;
    }
}

// –§–∞–π–ª verify-code.php –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
<?php
// verify-code.php
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type');

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
$data = json_decode(file_get_contents('php://input'), true);
$code = $data['code'] ?? '';

if (empty($code)) {
    echo json_encode(['success' => false, 'error' => '–ö–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω']);
    exit;
}

// –ß–∏—Ç–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–¥—ã
$codes_file = 'codes.json';
if (!file_exists($codes_file)) {
    echo json_encode(['success' => false, 'error' => '–ë–∞–∑–∞ –∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞']);
    exit;
}

$codes = json_decode(file_get_contents($codes_file), true);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
if (!isset($codes[$code])) {
    echo json_encode(['success' => false, 'error' => '–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω']);
    exit;
}

$code_data = $codes[$code];
$now = time();
$code_age = $now - $code_data['timestamp'];

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (10 –º–∏–Ω—É—Ç = 600 —Å–µ–∫—É–Ω–¥)
if ($code_age > 600) {
    echo json_encode(['success' => false, 'error' => '–ö–æ–¥ –∏—Å—Ç–µ–∫. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥']);
    exit;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ª–∏ —É–∂–µ
if ($code_data['used'] ?? false) {
    echo json_encode(['success' => false, 'error' => '–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω']);
    exit;
}

// –ü–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
$codes[$code]['used'] = true;
$codes[$code]['used_at'] = $now;

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
file_put_contents($codes_file, json_encode($codes, JSON_PRETTY_PRINT));

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
$token = bin2hex(random_bytes(32));
$user_id = $code_data['chat_id'];

// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é (–º–æ–∂–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)
$sessions_file = 'sessions.json';
$sessions = file_exists($sessions_file) ? json_decode(file_get_contents($sessions_file), true) : [];
$sessions[$token] = [
    'user_id' => $user_id,
    'username' => $code_data['user_name'] ?? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    'created_at' => $now,
    'ip' => $_SERVER['REMOTE_ADDR'] ?? ''
];
file_put_contents($sessions_file, json_encode($sessions, JSON_PRETTY_PRINT));

// –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
echo json_encode([
    'success' => true,
    'token' => $token,
    'user_id' => $user_id,
    'username' => $code_data['user_name'] ?? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    'message' => '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞'
]);
?>
